# Gemini Go開発ガイドライン

このドキュメントは、このプロジェクトでGoコードを記述する際の規約とベストプラクティスを概説します。これらのガイドラインに従うことで、コードベースの一貫性と品質を確保します。

## フォーマット

すべてのGoコードは `goimports` を使用してフォーマットする**必要があります**。このツールはコードを自動的にフォーマットし、インポートを管理することで、一貫したスタイルを保証します。ほとんどのエディタは、保存時に `goimports` を実行するように設定できます。

コードをコミットする前に、手動で次を実行できます:
```shell
goimports -w .
```

## リンティング

一般的なエラーやスタイルの問題を検出するために、静的解析ツールとして `golangci-lint` を使用します。変更を送信する前に、それがインストールされていることを確認し、実行してください:

```shell
golangci-lint run
```

## コードスタイル

- **ガード節を使用して早期リターンする。** エラーケースや事前条件を関数の早い段階でチェックし、すぐにリターンすることで、ネストを深くする `if-else` ブロックを避けます。これにより、メインのロジックがインデントの深い階層に埋もれることなく、コードの可読性が向上します。

  **悪い例:**
  ```go
  func process(item Item) error {
      if item.IsValid() {
          // ... 多くの処理
          if err == nil {
              // ... さらに多くの処理
              return nil
          } else {
              return err
          }
      } else {
          return errors.New("invalid item")
      }
  }
  ```

  **良い例:**
  ```go
  func process(item Item) error {
      if !item.IsValid() {
          return errors.New("invalid item")
      }

      // ... 多くの処理
      if err != nil {
          return err
      }

      // ... さらに多くの処理
      return nil
  }
  ```

## エラーハンドリング

- **エラーを決して無視しないこと。** エラーを安全に無視できる理由を明確に検討し、文書化した場合にのみ、ブランク識別子 `_` を使用してください。
- **エラーにコンテキストを追加すること。** エラーがコールスタックを上に伝播する場合、`%w` 動詞を持つ `fmt.Errorf` を使用して元のエラーをラップし、追加のコンテキストを提供します。

  ```go
  if err != nil {
      return fmt.Errorf("何かの処理に失敗しました: %w", err)
  }
  ```

## ロギング

- 構造化ロギングには、標準ライブラリの `log/slog` パッケージを使用してください。
- キーと値のペアでコンテキスト情報を追加することで、ログが機械可読で検索しやすくなります。
- デフォルトのロガーを設定するか、`context.Context` を介してロガーを渡すことを検討してください。

## テスト

- すべての新しい機能とバグ修正には、テストを添付する必要があります。
- アサーションには `testify/require` パッケージを使用してください。`require` はテストが失敗すると即座に実行を停止するため、`assert` よりも推奨されます。
- 複雑な構造体を比較する場合、`github.com/google/go-cmp/cmp` を使用して、テストが失敗したときに意味のある差分を提供します。
- 複数のシナリオをテストする場合は、テーブル駆動テストを積極的に使用してください。これにより、テストケースの追加や保守が容易になります。
- テストファイルの名前は `_test.go` サフィックスで終わる必要があります。

## コメント

- すべてのエクスポートされた関数、型、および定数には、ドキュメントコメントが必要です。
- コメントは明確かつ簡潔で、*何*を説明するだけでなく、*なぜ*そうするのかを説明する必要があります。
- Godocの場合、コメントが説明している要素の名前で始まるようにしてください。

  ```go
  // User はシステムのユーザーを表します。
  type User struct {
      // ...
  }
  ```

## 依存関係

プロジェクトの依存関係はGo Modulesを使用して管理されます。

- 新しい依存関係を追加するには、`go get` を使用します。
- 依存関係を変更した後は、`go mod tidy` を実行して `go.mod` および `go.sum` ファイルをクリーンアップします。